<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Single Writer Multiple Reader (SWMR) &mdash; h5py 2.5.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="h5py 2.5.0 documentation" href="index.html" />
    <link rel="next" title="Low-Level Interface" href="low.html" />
    <link rel="prev" title="Parallel HDF5" href="mpi.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="low.html" title="Low-Level Interface"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="mpi.html" title="Parallel HDF5"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">h5py 2.5.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="single-writer-multiple-reader-swmr">
<span id="swmr"></span><h1>Single Writer Multiple Reader (SWMR)<a class="headerlink" href="#single-writer-multiple-reader-swmr" title="Permalink to this headline">¶</a></h1>
<p>Starting with version 2.5.0, h5py includes support for the HDF5 SWMR features.</p>
<p>The SWMR feature is not available in the current release (1.8 series) of HDF5
library. It is planned to be released for production use in version 1.10. Until
then it is available as an experimental prototype form from development snapshot
version 1.9.178 on the
<a class="reference external" href="ftp://ftp.hdfgroup.uiuc.edu/pub/outgoing/SWMR/">HDF Group ftp server</a> or the
<a class="reference external" href="http://svn.hdfgroup.uiuc.edu/hdf5/branches/revise_chunks">HDF Group svn repository</a>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The SWMR feature is currently in prototype form and available for
experimenting and testing. Please do not consider this a production
quality feature until the HDF5 library is released as 1.10.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">FILES PRODUCED BY THE HDF5 1.9.X DEVELOPMENT SNAPSHOTS MAY NOT BE
READABLE BY OTHER VERSIONS OF HDF5, INCLUDING THE EXISTING 1.8
SERIES AND ALSO 1.10 WHEN IT IS RELEASED.</p>
</div>
<div class="section" id="what-is-swmr">
<h2>What is SWMR?<a class="headerlink" href="#what-is-swmr" title="Permalink to this headline">¶</a></h2>
<p>The SWMR features allow simple concurrent reading of a HDF5 file while it is
being written from another process. Prior to this feature addition it was not
possible to do this as the file data and meta-data would not be syncrhonised
and attempts to read a file which was open for writing would fail or result in
garbage data.</p>
<p>A file which is being written to in SWMR mode is guaranteed to always be in a
valid (non-corrupt) state for reading. This has the added benefit of leaving a
file in a valid state even if the writing application crashes before closing
the file properly.</p>
<p>This feature has been implemented to work with independent writer and reader
processes. No synchronisation is required between processes and it is up to the
user to implement either a file polling mechanism, inotify or any other IPC
mechanism to notify when data has been written.</p>
<p>The SWMR functionality requires use of the latest HDF5 file format: v110. In
practice this implies setting the libver bounding to &#8220;latest&#8221; when opening or
creating the file.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">New v110 format files are <em>not</em> compatible with v18 format. So
files, written in SWMR mode with libver=&#8217;latest&#8217; cannot be opened
with older versions of the HDF5 library (basically any version
older than the SWMR feature).</p>
</div>
<p>The HDF Group has documented the SWMR features in details on the website:
<a class="reference external" href="http://www.hdfgroup.org/HDF5/docNewFeatures/NewFeaturesSwmrDocs.html">Single-Writer/Multiple-Reader (SWMR) Documentation</a>.
This is highly recommended reading for anyone intending to use the SWMR feature
even through h5py. For production systems in particular pay attention to the
file system requirements regarding POSIX I/O semantics.</p>
</div>
<div class="section" id="using-the-swmr-feature-from-h5py">
<h2>Using the SWMR feature from h5py<a class="headerlink" href="#using-the-swmr-feature-from-h5py" title="Permalink to this headline">¶</a></h2>
<p>The following basic steps are typically required by writer and reader processes:</p>
<ul class="simple">
<li>Writer process create the target file and all groups, datasets and attributes.</li>
<li>Writer process switch file into SWMR mode.</li>
<li>Reader process can open the file with swmr=True.</li>
<li>Writer writes and/or appends data to existing datasets (new groups and datasets <em>cannot</em> be created when in SWMR mode).</li>
<li>Writer regularly flushes the target dataset to make it visible to reader processes.</li>
<li>Reader refreshes target dataset before reading new meta-data and/or main data.</li>
<li>Writer eventually completes and close the file as normal.</li>
<li>Reader can finish and close file as normal whenever it is convenient.</li>
</ul>
<p>The following snippet demonstrate a SWMR writer appending to a single dataset:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s">&quot;swmr.h5&quot;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">libver</span><span class="o">=</span><span class="s">&#39;latest&#39;</span><span class="p">)</span>
<span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
<span class="n">dset</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,),</span> <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span> <span class="n">data</span><span class="o">=</span><span class="n">arr</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">swmr_mode</span> <span class="o">=</span> <span class="bp">True</span>
<span class="c"># Now it is safe for the reader to open the swmr.h5 file</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">new_shape</span> <span class="o">=</span> <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span> <span class="p">)</span>
    <span class="n">dset</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="n">new_shape</span> <span class="p">)</span>
    <span class="n">dset</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">):]</span> <span class="o">=</span> <span class="n">arr</span>
    <span class="n">dset</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="c"># Notify the reader process that new data has been written</span>
</pre></div>
</div>
<p>The following snippet demonstrate how to monitor a dataset as a SWMR reader:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s">&quot;swmr.h5&quot;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">libver</span><span class="o">=</span><span class="s">&#39;latest&#39;</span><span class="p">,</span> <span class="n">swmr</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">dset</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">dset</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">print</span><span class="p">(</span> <span class="n">shape</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>In addition to the above example snippets, a few more complete examples can be
found in the examples folder. These examples are described in the following
sections</p>
<div class="section" id="dataset-monitor-with-inotify">
<h3>Dataset monitor with inotify<a class="headerlink" href="#dataset-monitor-with-inotify" title="Permalink to this headline">¶</a></h3>
<p>The inotify example demonstrate how to use SWMR in a reading application which
monitors live progress as a dataset is being written by another process. This
example uses the the linux inotify
(<a class="reference external" href="https://pypi.python.org/pypi/pyinotify">pyinotify</a> python bindings) to
receive a signal each time the target file has been updated.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Demonstrate the use of h5py in SWMR mode to monitor the growth of a dataset</span>
<span class="sd">    on nofication of file modifications.</span>
<span class="sd">    </span>
<span class="sd">    This demo uses pyinotify as a wrapper of Linux inotify.</span>
<span class="sd">    https://pypi.python.org/pypi/pyinotify</span>
<span class="sd">    </span>
<span class="sd">    Usage:</span>
<span class="sd">            swmr_inotify_example.py [FILENAME [DATASETNAME]]</span>
<span class="sd">            </span>
<span class="sd">              FILENAME:    name of file to monitor. Default: swmr.h5</span>
<span class="sd">              DATASETNAME: name of dataset to monitor in DATAFILE. Default: data</span>
<span class="sd">            </span>
<span class="sd">    This script will open the file in SWMR mode and monitor the shape of the</span>
<span class="sd">    dataset on every write event (from inotify). If another application is </span>
<span class="sd">    concurrently writing data to the file, the writer must have have switched </span>
<span class="sd">    the file into SWMR mode before this script can open the file.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">asyncore</span>
<span class="kn">import</span> <span class="nn">pyinotify</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="c">#assert h5py.version.hdf5_version_tuple &gt;= (1,9,178), &quot;SWMR requires HDF5 version &gt;= 1.9.178&quot;</span>

<span class="k">class</span> <span class="nc">EventHandler</span><span class="p">(</span><span class="n">pyinotify</span><span class="o">.</span><span class="n">ProcessEvent</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">monitor_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">datasetname</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Opening file </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">libver</span><span class="o">=</span><span class="s">&#39;latest&#39;</span><span class="p">,</span> <span class="n">swmr</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Looking up dataset </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">datasetname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">datasetname</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_dset_shape</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">get_dset_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Refreshing dataset&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dset</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Getting shape&quot;</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dset</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Read data shape: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">shape</span>        
        
    <span class="k">def</span> <span class="nf">read_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latest</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Reading out dataset [</span><span class="si">%d</span><span class="s">]&quot;</span><span class="o">%</span><span class="n">latest</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dset</span><span class="p">[</span><span class="n">latest</span><span class="p">:]</span>
                
    <span class="k">def</span> <span class="nf">process_IN_MODIFY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;File modified!&quot;</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dset_shape</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_dataset</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    
    <span class="k">def</span> <span class="nf">process_IN_CLOSE_WRITE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;File writer closed file&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_dset_shape</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Good bye!&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%(asctime)s</span><span class="s">  </span><span class="si">%(levelname)s</span><span class="se">\t</span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    
    <span class="n">file_name</span> <span class="o">=</span> <span class="s">&quot;swmr.h5&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dataset_name</span> <span class="o">=</span> <span class="s">&quot;data&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>


    <span class="n">wm</span> <span class="o">=</span> <span class="n">pyinotify</span><span class="o">.</span><span class="n">WatchManager</span><span class="p">()</span>  <span class="c"># Watch Manager</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">pyinotify</span><span class="o">.</span><span class="n">IN_MODIFY</span> <span class="o">|</span> <span class="n">pyinotify</span><span class="o">.</span><span class="n">IN_CLOSE_WRITE</span> 
    <span class="n">evh</span> <span class="o">=</span> <span class="n">EventHandler</span><span class="p">()</span>
    <span class="n">evh</span><span class="o">.</span><span class="n">monitor_dataset</span><span class="p">(</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">dataset_name</span> <span class="p">)</span>

    <span class="n">notifier</span> <span class="o">=</span> <span class="n">pyinotify</span><span class="o">.</span><span class="n">AsyncNotifier</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">evh</span><span class="p">)</span>
    <span class="n">wdd</span> <span class="o">=</span> <span class="n">wm</span><span class="o">.</span><span class="n">add_watch</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">rec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># Sit in this loop() until the file writer closes the file</span>
    <span class="c"># or the user hits ctrl-c</span>
    <span class="n">asyncore</span><span class="o">.</span><span class="n">loop</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="multiprocess-concurrent-write-and-read">
<h3>Multiprocess concurrent write and read<a class="headerlink" href="#multiprocess-concurrent-write-and-read" title="Permalink to this headline">¶</a></h3>
<p>The SWMR multiprocess example starts starts two concurrent child processes:
a writer and a reader.
The writer process first creates the target file and dataset. Then it switches
the file into SWMR mode and the reader process is notified (with a
multiprocessing.Event) that it is safe to open the file for reading.</p>
<p>The writer process then continue to append chunks to the dataset. After each
write it notifies the reader that new data has been written. Whether the new
data is visible in the file at this point is subject to OS and file system
latencies.</p>
<p>The reader first waits for the initial &#8220;SWMR mode&#8221; notification from the
writer, upon which it goes into a loop where it waits for further notifications
from the writer. The reader may drop some notifications, but for each one
received it will refresh the dataset and read the dimensions. After a time-out
it will drop out of the loop and exit.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Demonstrate the use of h5py in SWMR mode to write to a dataset (appending) </span>
<span class="sd">    from one process while monitoring the growing dataset from another process.</span>
<span class="sd">    </span>
<span class="sd">    Usage:</span>
<span class="sd">            swmr_multiprocess.py [FILENAME [DATASETNAME]]</span>
<span class="sd">            </span>
<span class="sd">              FILENAME:    name of file to monitor. Default: swmrmp.h5</span>
<span class="sd">              DATASETNAME: name of dataset to monitor in DATAFILE. Default: data</span>
<span class="sd">            </span>
<span class="sd">    This script will start up two processes: a writer and a reader. The writer</span>
<span class="sd">    will open/create the file (FILENAME) in SWMR mode, create a dataset and start</span>
<span class="sd">    appending data to it. After each append the dataset is flushed and an event</span>
<span class="sd">    sent to the reader process. Meanwhile the reader process will wait for events </span>
<span class="sd">    from the writer and when triggered it will refresh the dataset and read the </span>
<span class="sd">    current shape of it.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Event</span>

<span class="k">class</span> <span class="nc">SwmrReader</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dsetname</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SwmrReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fname</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dsetname</span> <span class="o">=</span> <span class="n">dsetname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;reader&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Waiting for initial event&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Opening file </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fname</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fname</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">libver</span><span class="o">=</span><span class="s">&#39;latest&#39;</span><span class="p">,</span> <span class="n">swmr</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">swmr_mode</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dsetname</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># monitor and read loop</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Refreshing dataset&quot;</span><span class="p">)</span>
                <span class="n">dset</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

                <span class="n">shape</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">shape</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Read dset shape: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">SwmrWriter</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dsetname</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SwmrWriter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event</span> <span class="o">=</span> <span class="n">event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fname</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dsetname</span> <span class="o">=</span> <span class="n">dsetname</span>
        
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;writer&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Creating file </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fname</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fname</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">libver</span><span class="o">=</span><span class="s">&#39;latest&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">dset</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dsetname</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,),</span> <span class="n">maxshape</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,),</span> <span class="n">data</span><span class="o">=</span><span class="n">arr</span><span class="p">)</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">swmr_mode</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;SWMR mode&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">swmr_mode</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">swmr_mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Sending initial event&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>        

            <span class="c"># Write loop</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">new_shape</span> <span class="o">=</span> <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Resizing dset shape: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">new_shape</span><span class="p">))</span>
                <span class="n">dset</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span> <span class="n">new_shape</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Writing data&quot;</span><span class="p">)</span>
                <span class="n">dset</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">):]</span> <span class="o">=</span> <span class="n">arr</span>
                <span class="c">#dset.write_direct( arr, np.s_[:], np.s_[i*len(arr):] )</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Flushing data&quot;</span><span class="p">)</span>
                <span class="n">dset</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Sending event&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%(levelname)10s</span><span class="s">  </span><span class="si">%(asctime)s</span><span class="s">  </span><span class="si">%(name)10s</span><span class="s">  </span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s">&#39;swmrmp.h5&#39;</span>
    <span class="n">dsetname</span> <span class="o">=</span> <span class="s">&#39;data&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">dsetname</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        
    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">SwmrReader</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dsetname</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">SwmrWriter</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dsetname</span><span class="p">)</span>
    
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Starting reader&quot;</span><span class="p">)</span>
    <span class="n">reader</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Starting reader&quot;</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Waiting for writer to finish&quot;</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Waiting for reader to finish&quot;</span><span class="p">)</span>
    <span class="n">reader</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
<p>The example output below (from a virtual Ubuntu machine) illustrate some
latency between the writer and reader:</p>
<div class="highlight-python"><div class="highlight"><pre>python examples/swmr_multiprocess.py
  INFO  2015-02-26 18:05:03,195        root  Starting reader
  INFO  2015-02-26 18:05:03,196        root  Starting reader
  INFO  2015-02-26 18:05:03,197      reader  Waiting for initial event
  INFO  2015-02-26 18:05:03,197        root  Waiting for writer to finish
  INFO  2015-02-26 18:05:03,198      writer  Creating file swmrmp.h5
  INFO  2015-02-26 18:05:03,203      writer  SWMR mode
  INFO  2015-02-26 18:05:03,205      reader  Opening file swmrmp.h5
  INFO  2015-02-26 18:05:03,210      writer  Resizing dset shape: (4,)
  INFO  2015-02-26 18:05:03,212      writer  Sending event
  INFO  2015-02-26 18:05:03,213      reader  Read dset shape: (4,)
  INFO  2015-02-26 18:05:03,214      writer  Resizing dset shape: (8,)
  INFO  2015-02-26 18:05:03,214      writer  Sending event
  INFO  2015-02-26 18:05:03,215      writer  Resizing dset shape: (12,)
  INFO  2015-02-26 18:05:03,215      writer  Sending event
  INFO  2015-02-26 18:05:03,215      writer  Resizing dset shape: (16,)
  INFO  2015-02-26 18:05:03,215      reader  Read dset shape: (12,)
  INFO  2015-02-26 18:05:03,216      writer  Sending event
  INFO  2015-02-26 18:05:03,216      writer  Resizing dset shape: (20,)
  INFO  2015-02-26 18:05:03,216      reader  Read dset shape: (16,)
  INFO  2015-02-26 18:05:03,217      writer  Sending event
  INFO  2015-02-26 18:05:03,217      reader  Read dset shape: (20,)
  INFO  2015-02-26 18:05:03,218      reader  Read dset shape: (20,)
  INFO  2015-02-26 18:05:03,219        root  Waiting for reader to finish
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Single Writer Multiple Reader (SWMR)</a><ul>
<li><a class="reference internal" href="#what-is-swmr">What is SWMR?</a></li>
<li><a class="reference internal" href="#using-the-swmr-feature-from-h5py">Using the SWMR feature from h5py</a></li>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#dataset-monitor-with-inotify">Dataset monitor with inotify</a></li>
<li><a class="reference internal" href="#multiprocess-concurrent-write-and-read">Multiprocess concurrent write and read</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="mpi.html"
                        title="previous chapter">Parallel HDF5</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="low.html"
                        title="next chapter">Low-Level Interface</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/swmr.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="low.html" title="Low-Level Interface"
             >next</a> |</li>
        <li class="right" >
          <a href="mpi.html" title="Parallel HDF5"
             >previous</a> |</li>
        <li><a href="index.html">h5py 2.5.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Andrew Collette and contributors.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>